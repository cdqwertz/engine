<html>
	<head>
		<title>Game Editor</title>
		<style>
			body {
				background-color: #f7f7f7;
			}

			#objects {
				background-color: #f3f3f3;
				border: 1px solid #d3d3d3;
				list-style-type: none;

				position: fixed;
				top: 50px;
				left: -170;
				width: 200px;
				height: 70%;
				margin: 0;
				padding: 0;
				overflow: hidden;
			}


			#objects:hover {
				background-color: #f3f3f3;
				border: 1px solid #d3d3d3;
				list-style-type: none;

				position: fixed;
				top: 50px;
				left: 0;
				width: 200px;
				height: 70%;
				margin: 0;
				padding: 0;
				overflow: hidden;
			}
				
			#objects li {
				 float: top;
			}

			#objects li a {
				display: block;
				text-align: center;
				padding: 14px 16px;
				text-decoration: none;
				color: black;
			}

			#objects li a:hover {
				display: block;
				text-align: center;
				padding: 14px 16px;
				text-decoration: none;
				color: black;
				background-color: #777777;

				box-shadow: 0px 0px 5px grey; 
			}




			#nav {
				background-color: #f3f3f3;
				border: 1px solid #d3d3d3;
				list-style-type: none;

				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				margin: 0;
				padding: 0;
				overflow: hidden;
			}

			#nav #l {
				 float: left;
			}

			#nav #r {
				 float: right;
			}

			#nav li a {
				display: block;
				text-align: center;
				padding: 14px 16px;
				text-decoration: none;
				color: black;
			}
			
			#nav li a:hover {
				display: block;
				text-align: center;
				padding: 14px 16px;
				text-decoration: none;

				color: black;
				background-color: #777777;
				box-shadow: 0px 0px 5px grey; 
			}

			#code {
				position:absolute;
				z-index: -1;
				top:0px;
				left:0px;
			}
		</style>
	</head>
	<body onload="load();">
		<script>
			var scenes = [["mainScene"]];
			var scene = 0;

			var selectedObject;

			var objectsGUI;
			var codeGUI;
			var codeCtx;

			var components = [[]];
			var component = 0;

			var codeCmds = [];

			function load() {
				objectsGUI = document.getElementById("objects");
				codeGUI = document.getElementById("code");
				codeCtx = codeGUI.getContext("2d");

				codeGUI.width = document.body.clientWidth;
				codeGUI.height = document.body.clientHeight;

				updateEditorGUI();
				codeGUI.onmousedown = codeOnMouseDown;
				codeGUI.onmouseup = codeOnMouseUp;
				codeGUI.onmousemove = codeOnMouseMove;

				showObjectsGUI();
			}

			//code editor

			var codeMouseDown = false;
			var codeSelectedObject = [-1];

			function codeOnMouseDown(e) {
				codeMouseDown = true;
				var x = e.clientX;
				var y = e.clientY;
				console.log(x + "," + y);

				if(component != -1) {
					for(var i = 0; i < components[component].length; i++){
						if(x > components[component][i][0] &&
						   x < components[component][i][0]+100 &&
						   y > components[component][i][1] &&
						   y < components[component][i][1]+100) {
							codeSelectedObject = [0,i];
							updateEditorGUI();
						}
						if(x > components[component][i][0]+100 &&
						   x < components[component][i][0]+115 &&
						   y > components[component][i][1]+10 &&
						   y < components[component][i][1]+25) {
							codeSelectedObject = [1,i];
							updateEditorGUI();
						}
					}
				}
				
			}

			function codeOnMouseUp(e) {
				var x = e.clientX;
				var y = e.clientY;
				if(component != -1 && codeSelectedObject[0] == 1) {
					for(var i = 0; i < components[component].length; i++){
						if(x > components[component][i][0]-15 &&
						   x < components[component][i][0]+10 &&
						   y > components[component][i][1] &&
						   y < components[component][i][1]+25) {
							components[component][codeSelectedObject[1]][3].push([i]);
							updateEditorGUI();
						}
					}
				}
				codeMouseDown = false;
				codeSelectedObject = [-1];
			}

			function codeOnMouseMove(e) {
				if(codeMouseDown) {
					var x = e.clientX;
					var y = e.clientY;
					if(component != -1 && codeSelectedObject[0] != -1) {
						if(codeSelectedObject[0] == 0) {
							components[component][codeSelectedObject[1]][0] = x -50;
							components[component][codeSelectedObject[1]][1] = y -50;
							updateEditorGUI();
						}
					}
				}
			}

			
			function updateEditorGUI() {
				codeCtx.clearRect(0,0,codeGUI.width,codeGUI.height);
				if(component != -1) {
					for(var i = 0; i < components[component].length; i++){
						codeDrawCmd(components[component][i]);
					}
				}
			}

			function codeDrawCmd(d) {
				codeCtx.strokeRect(d[0],d[1], 100, 100);
				codeCtx.fillText(d[2],d[0]+20,d[1] + 20);

				//draw inputs
				codeCtx.strokeRect(d[0]-15,d[1]+10, 15, 15);
				
				//draw outputs
				codeCtx.strokeRect(d[0]+100,d[1]+10, 15, 15);

				//draw connections
				for(var i = 0; i < d[3].length; i++){
					codeCtx.beginPath();
					codeCtx.moveTo(d[0]+107,d[1]+17, 15, 15);
					var c = components[component][d[3][i][0]];
					codeCtx.lineTo(c[0]-10,c[1]+17, 15, 15);
					codeCtx.stroke();
				}
			}

			function codeAddCmd(n) {
				components[component].push([200, 200, codeCmds[n][0], []]); 
				updateEditorGUI();
			}

			function codeAddConnection(n) {
				components[component][n][3].push([n]); 
				updateEditorGUI();
			}

			function codeRegisterCmd(name) {
				codeCmds.push([name])
			}

			//register commands

			codeRegisterCmd("test");
			

			

			//gui

			function showObjectsGUI() {
				var s = "";
				for(var i = 1; i < scenes[scene].length; i++) {
					s += "<li><a onclick=\"GUISelectObject(" + i + ");return false;\">" + scenes[scene][i][0] + "</a></li>";
				}
				s += "<li><a onclick=\"addActor();return false;\">Add Actor</a></li>";
				objectsGUI.innerHTML = s;
			}

			function showComponentsGUI() {
				var s = "";
				if(selectedObject == -1) {
					return 0;
				}
				s += "<li><a onclick=\"showObjectsGUI();return false;\">Back</a></li>";
				for(var i = 1; i < scenes[scene][selectedObject].length; i++) {
					s += "<li><a onclick=\"GUISelectComponent(" + i + ");return false;\">" + scenes[scene][selectedObject][i][0] + "</a></li>";
				}
				s += "<li><a onclick=\"addComponent();return false;\">Add Component</a></li>";
				objectsGUI.innerHTML = s;
			}

			function GUISelectObject(i) {
				selectedObject = i;
				showComponentsGUI();
			}
			function GUISelectComponent(n) {
				var s = "";
				if(selectedObject == -1) {
					return 0;
				}
				s += "<li><a onclick=\"showComponentsGUI();return false;\">Back</a></li>";
				for(var i = 1; i < scenes[scene][selectedObject][n].length; i++) {
					s += "<li><a><input type=\"text\" value=\"" + scenes[scene][selectedObject][n][i] + "\" onchange = \"scenes[scene][selectedObject]["+n+"]["+i+"] = this.value; GUISelectComponent(" + n+");\"></input></a></li>";
				}
				//s += "<li><a onclick=\"addComponent();return false;\">Add Component</a></li>";
				objectsGUI.innerHTML = s;
			}

			//generate Code

			function newGame() {
			}

			function saveGame() {
			}
			
			function openGame() {
			}

			function showCode() {
				alert(genCode());
			}

			function genParams(l) {
				var s = "";
				for(var i = 1; i < l.length; i++){
					s += l[i] + ",";
				}
				s = s.substring(0, s.length-1);
				return s;
			}

			function genCode() {
				var code = "function load() {\n";
				for(var i = 0; i < scenes.length; i++){
					for(var j = 1; j < scenes[i].length; j++){
						code += "\tvar " + scenes[i][j][0] + " = new actor();\n" ;
						for(var k = 1; k < scenes[i][j].length; k++){
							code += "\t" + scenes[i][j][0] + ".addComponent(new " + scenes[i][j][k][0] + "(" + genParams(scenes[i][j][k]) + "));\n" ;
						}
						code += "\tmainScene.addObject(" + scenes[i][j][0] + ");\n\n" ;
					}
				}
				code += "}";
				return code;
			}

			//add actors, scenes...

			function addActor() {
				var n = prompt("Name:");
				if(n) {
					var p = scenes[scene].push([]);
					scenes[scene][p-1].push(n);
				}
				showObjectsGUI();
			}
			
			function addComponent() {
				var n = prompt("Type:");
				if(n) {
					var p = scenes[scene][selectedObject].push([]);
					scenes[scene][selectedObject][p-1].push(n);
					if(n == "transform") {
						scenes[scene][selectedObject][p-1].push("new vec2(0, 0)");
						scenes[scene][selectedObject][p-1].push("new vec2(0, 0)");
					} else if(n == "drawRect") {
						scenes[scene][selectedObject][p-1].push("new vec2(0, 0)");
						scenes[scene][selectedObject][p-1].push("new vec2(0, 0)");
					} else if(n == "drawImage") {
						scenes[scene][selectedObject][p-1].push("new vec2(0, 0)");
						scenes[scene][selectedObject][p-1].push("new Image()");
						scenes[scene][selectedObject][p-1].push("0");
						scenes[scene][selectedObject][p-1].push("512");
						scenes[scene][selectedObject][p-1].push("512");
						scenes[scene][selectedObject][p-1].push("[]");
					} else if(n == "boxCollider") {
						scenes[scene][selectedObject][p-1].push("0");
						scenes[scene][selectedObject][p-1].push("0");

						scenes[scene][selectedObject][p-1].push("512");
						scenes[scene][selectedObject][p-1].push("512");

						scenes[scene][selectedObject][p-1].push("");
						scenes[scene][selectedObject][p-1].push("false");
					}
				}
				showComponentsGUI();
			}
		</script>

		<ul id="nav">

			<li id="l"><a onclick="newGame();return false;">New</a></li>
			<li id="l"><a onclick="openGame();return false;">Open</a></li>
			<li id="l"><a onclick="saveGame();return false;">Save</a></li>
			<li id="l"><a onclick="showCode();return false;">Export</a></li>

			<li id="r"><a onclick="codeAddCmd(0);return false;">Add Command</a></li>
		</ul>

		<ul id="objects">
		</ul>

		<canvas id="code">
		</canvas>
	</body>
</html>
